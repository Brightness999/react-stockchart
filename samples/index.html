<!doctype html>
<html>
<head>
	<title>ClChart Demo</title>
	<meta data-n-head="true" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<meta name="description" content="A fast, simple, cross-platform, and configurable stock chart library created using canvas.">
	<meta name="keywords" content="chart, canvas, stock chart, fast, simple, cross-platform, configurable">
	<script src="./clchart.js"></script>
	<script src="./menus.js?v=1"></script>
	<link rel="stylesheet" type="text/css" href="./style.css?v=1" />
</head>

<body class="theme-black">
	<div class="container">
		<div class="header-container">
			<div id="drawMenu">
			</div>
			<div id="toggleTheme">
					<i id="iconSun" class="icon-sun"></i>
					<i id="iconMoon" class="icon-moon" style="display: none;"></i>
			</div>
			<div id="langMenu">
			</div>
		</div>
		<div class="chart-container">
			<canvas id="myChart" width="400" height="600"></canvas>
		</div>
		<div id="spinner" class="spinner">
			<i class="icon-spin5 animate-spin"></i>
		</div>
	</div>
	<script src="./stockdata.js"></script>
	<script>
		'use strict'
		// 开始画图
		const canvas = document.getElementById('myChart')
		const ctx = canvas.getContext('2d')
		const syscfg = {
			canvas,
			scale: window.devicePixelRatio,
			context: ctx
		}
		const Chart = ClChart.createSingleChart(syscfg)
		// 画分钟线
		function handleMin (code) {
			console.log('Draw ====> Min Line')
			// 清除画布，及数据
			Chart.clear()
			// 初始化数据
			Chart.initData(20180413, ClChart.DEF_DATA.STOCK_TRADETIME)
			// 设置相应的数据
			Chart.setData('INFO', ClChart.DEF_DATA.FIELD_INFO, getMockData(code, 'INFO'))
			Chart.setData('MIN', ClChart.DEF_DATA.FIELD_MIN, getMockData(code, 'MIN'))
			Chart.setData('TICK', ClChart.DEF_DATA.FIELD_TICK, getMockData(code, 'TICK'))
			Chart.setData('NOW', ClChart.DEF_DATA.FIELD_NOW, getMockData(code, 'NOW'))
			// 设置画布尺寸
			let mainHeight = canvas.height * 2 / 3
			let mainWidth = Math.max(canvas.width * 0.65, canvas.width - 400)
			if (code === 'SH000001') mainWidth = canvas.width
			// 设置画布区域布局
			const mainLayoutCfg = {
				layout: ClChart.DEF_CHART.CHART_LAYOUT,
				config: ClChart.DEF_CHART.CHART_NOW,
				rectMain: {
					left: 0,
					top: 0,
					width: mainWidth,
					height: mainHeight
				}
			}
			const mainChart = Chart.createChart('MIN', 'CHART.LINE', mainLayoutCfg, function (result) {
				//  console.log(result)
			})
			Chart.bindData(mainChart, 'MIN')

			const volumeLoyoutCfg = {
				layout: ClChart.DEF_CHART.CHART_LAYOUT,
				config: ClChart.DEF_CHART.CHART_NOWVOL,
				rectMain: {
					left: 0,
					top: mainHeight,
					width: mainWidth,
					height: canvas.height - mainHeight
				}
			}
			const volumeChart = Chart.createChart('MINNOW', 'CHART.LINE', volumeLoyoutCfg, function (result) {
				//  console.log(result)
			})
			Chart.bindData(volumeChart, 'MIN')

			if (code !== 'SH000001') {
				const orderLayoutCfg = {
					layout: ClChart.DEF_CHART.CHART_LAYOUT,
					config: ClChart.DEF_CHART.CHART_ORDER,
					rectMain: {
						left: mainWidth,
						top: 0,
						width: canvas.width - mainWidth,
						height: canvas.height
					}
				}
				const orderChart = Chart.createChart('ORDER', 'CHART.ORDER', orderLayoutCfg, function (result) {
					//  console.log(result)
				})
				// ??? 为什么可以不绑定数据
				// Chart.bindData(orderChart, 'TICK')
			}

			Chart.onPaint()
		}
		// 画五日线
		function handleFiveDay (code) {
			console.log('Five Day Line')
			Chart.clear()
			Chart.initData(20180413, ClChart.DEF_DATA.STOCK_TRADETIME)
			Chart.setData('INFO', ClChart.DEF_DATA.FIELD_INFO, getMockData(code, 'INFO'))
			Chart.setData('DAY5', ClChart.DEF_DATA.FIELD_DAY5, getMockData(code, 'DAY5'))
			Chart.setData('MIN', ClChart.DEF_DATA.FIELD_MIN, getMockData(code, 'MIN'))
			const mainHeight = canvas.height * 2 / 3
			const mainLayoutCfg = {
				layout: ClChart.DEF_CHART.CHART_LAYOUT,
				config: ClChart.DEF_CHART.CHART_DAY5,
				rectMain: {
					left: 0,
					top: 0,
					width: canvas.width,
					height: mainHeight
				}
			}
			const KBarChart = Chart.createChart('DAY5', 'CHART.LINE', mainLayoutCfg, function (result) {
				//  console.log(result)
			})
			Chart.bindData(KBarChart, 'DAY5')

			const volumeLoyoutCfg = {
				layout: ClChart.DEF_CHART.CHART_LAYOUT,
				config: ClChart.DEF_CHART.CHART_DAY5VOL,
				rectMain: {
					left: 0,
					top: mainHeight,
					width: canvas.width,
					height: canvas.height - mainHeight
				}
			}
			const KVBarChart = Chart.createChart('VLINE5', 'CHART.LINE', volumeLoyoutCfg, function (result) {
				//  console.log(result)
			})
			Chart.bindData(KVBarChart, 'DAY5')

			Chart.onPaint()
		}
		// 画日线
		function handleKline (fullCode, peroid) {
			let source = peroid
			if (peroid === 'WEEK' || peroid === 'MON') source = 'DAY'
			Chart.clear()
			Chart.initData(20180413, ClChart.DEF_DATA.STOCK_TRADETIME)
			Chart.setData('INFO', ClChart.DEF_DATA.FIELD_INFO, getMockData('SZ300545', 'INFO'))
			Chart.setData('RIGHT', ClChart.DEF_DATA.FIELD_RIGHT, getMockData('SZ300545', 'RIGHT'))
			Chart.setData(source, ClChart.DEF_DATA.FIELD_DAY, getMockData('SZ300545', source))
			const mainHeight = canvas.height * 2 / 3
			const mainLayoutCfg = {
				layout: {
					offset: {
						left: 5,
						right: 50
					}
				},
				buttons: ClChart.DEF_CHART.CHART_BUTTONS,
				config: ClChart.DEF_CHART.CHART_KBAR,
				rectMain: {
					left: 0,
					top: 0,
					width: canvas.width,
					height: mainHeight
				}
			}
			const KBarChart = Chart.createChart('KBAR', 'CHART.LINE', mainLayoutCfg, function (result) {
				//  console.log(result)
			})
			Chart.bindData(KBarChart, peroid)

			const volumeLoyoutCfg = {
				layout: {
					offset: {
						left: 5,
						right: 50
					}
				},
				config: ClChart.DEF_CHART.CHART_VBAR,
				rectMain: {
					left: 0,
					top: mainHeight,
					width: canvas.width,
					height: canvas.height - mainHeight
				}
			}
			const KVBarChart = Chart.createChart('VBAR', 'CHART.LINE', volumeLoyoutCfg, function (result) {
				//  console.log(result)
			})
			Chart.bindData(KVBarChart, peroid)

			Chart.onPaint()
		}
		function handleSeer () {
			Chart.clear()
			Chart.initData(20180413, ClChart.DEF_DATA.STOCK_TRADETIME)
			Chart.setData('INFO', ClChart.DEF_DATA.FIELD_INFO, getMockData('SZ300545', 'INFO'))
			Chart.setData('RIGHT', ClChart.DEF_DATA.FIELD_RIGHT, getMockData('SZ300545', 'RIGHT'))
			Chart.setData('DAY', ClChart.DEF_DATA.FIELD_DAY, getMockData('SZ300545', 'DAY'))
			Chart.setData('SEER', ClChart.PLUGINS.FIELD_SEER, getMockData('SZ300545', 'SEER'))
			Chart.setData('SEERHOT', {}, ['17'])
			const mainHeight = canvas.height * 2 / 3
			const mainLayoutCfg = {
				layout: {
					offset: {
						left: 5,
						right: 100,
						top: 20,
						bottom: 20
					}
				},
				buttons: [ { key: 'zoomin' }, { key: 'zoomout' } ],
				config: ClChart.PLUGINS.CHART_SEER,
				rectMain: {
					left: 0,
					top: 0,
					width: canvas.width,
					height: mainHeight
				}
			}
			const KBarChart = Chart.createChart('SEER', 'CHART.LINE', mainLayoutCfg, function (result) {
				//  console.log(result)
			})
			Chart.bindData(KBarChart, 'DAY')

			const volumeLayoutCfg = {
				layout: {
					offset: {
						left: 5,
						right: 50
					}
				},
				config: ClChart.DEF_CHART.CHART_VBAR,
				rectMain: {
					left: 0,
					top: mainHeight,
					width: canvas.width,
					height: canvas.height - mainHeight
				}
			}
			const KVBarChart = Chart.createChart('VBAR', 'CHART.LINE', volumeLayoutCfg, function (result) {
				//  console.log(result)
			})
			Chart.bindData(KVBarChart, 'DAY')

			Chart.onPaint()
		}

		const menuTypes = {
			MIN: handleMin,
			DAY5: handleFiveDay,
			DAY: handleKline,
			WEEK: handleKline,
			MON: handleKline,
			M5: handleKline,
			SEER: handleSeer
		}

		// 画图
		function drawChart (data) {
			data = data || {}
			const drawFunc = menuTypes[data.type]
			if (typeof drawFunc === 'function') {
				drawFunc(data.fc, data.type)
			}
		}

		const typeMenusCfg = [
			{ type: 'MIN', fc: 'SH000001', label: '分时(指数)' },
			{ type: 'DAY5', fc: 'SH000001', label: '五日(指数)' },
			{ type: 'MIN', fc: 'SZ300545', label: '分时' },
			{ type: 'DAY5', fc: 'SZ300545', label: '五日' },
			{ type: 'DAY', fc: 'SZ300545', label: '日K' },
			{ type: 'WEEK', fc: 'SZ300545', label: '周线' },
			{ type: 'MON', fc: 'SZ300545', label: '月线' },
			{ type: 'M5', fc: 'SZ300545', label: '5分钟' },
			{ type: 'SEER', fc: 'SZ300545', label: '预测' }
		]
		const langMenusCfg = [
			{ type: 'zh', label: '中文' },
			{ type: 'en', label: 'English' }
		]
		let drawMenus
		let langMenus
		window.onload = function () {
			const spinner = document.getElementById('spinner')
			spinner.style.display = 'none'
			drawChart(typeMenusCfg[0])
			drawMenus = new ListMenus('drawMenu', typeMenusCfg)
			drawMenus.createMenus(function (activeData) {
				drawChart(activeData)
			})
			langMenus = new ListMenus('langMenu', langMenusCfg)
			langMenus.createMenus(function (activeData) {
				console.log(activeData)
			});
			// 切换主题颜色
			let theme = 'black';
			function hanldeToggleTheme() {
				const sumDom = document.getElementById('iconSun')
				const moonDom = document.getElementById('iconMoon')
				if (theme === 'black') {
					moonDom.style.display = 'block'
					sumDom.style.display = 'none'
					theme = 'white'
				} else {
					moonDom.style.display = 'none'
					sumDom.style.display = 'block'
					theme = 'black'
				}
				document.body.className = 'theme-' + theme
				// let timer = Date.now()
				Chart.setColor(theme)
				// 需要手动onPaint一次
				Chart.onPaint()
				// console.log('-------', Date.now() - timer)
			}
			const toggleThemeDom = document.getElementById('toggleTheme');
			toggleThemeDom.addEventListener('click', hanldeToggleTheme)
		}
		window.onresize = function () {
			canvas.width = canvas.clientWidth * window.devicePixelRatio
			canvas.height = canvas.clientHeight * window.devicePixelRatio
			drawChart(drawMenus.active)
		}
	</script>
</body>

</html>