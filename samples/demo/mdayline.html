<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>ClChat Demo</title>
  <link rel="stylesheet" href="../css/client.css">
</head>
<body>
  <div class="container">
    <canvas class="chart-canvas" id="myChart" width="400" height="600"></canvas>
    <canvas class="chart-canvas" id="cursorChart" width="400" height="600"></canvas>
  </div>

  <script src="../ClChart.js"></script>
  <script src="../SisClient.js"></script>

  <script>

    var sisClient = new SisClient.Client({
      SocketConstructor: WebSocket,
      // endpoint: 'ws://139.224.34.238:7329',
      endpoint: 'ws://192.168.3.118:7329',
    })

    // get main canvas && cursor canvas
    // mainCanvas Used to draw the main map
    // cursorCanvas : Used to draw cross cursors
    const mainCanvas = document.getElementById('myChart')
    const mainCtx = mainCanvas.getContext('2d')
    const cursorCanvas = document.getElementById('cursorChart')
    const cursorCtx = cursorCanvas.getContext('2d')
  
    const syscfg = {
      scale: window.devicePixelRatio,
      axisPlatform: 'web', // 'phone' | 'web'
      mainCanvas: {
        canvas: mainCanvas,
        context: mainCtx
      },
      cursorCanvas: {
        canvas: cursorCanvas,
        context: cursorCtx
      }
    }
    // Create a single stock Chart instance
    const Chart = ClChart.createSingleChart(syscfg)
    let isInited = false;

    function initLayout() {
      if (isInited) return; 
      isInited = true;

      Chart.clearLayout();
      let mainHeight = mainCanvas.height * 2 / 3
      // 设置画布区域布局
      const mainLayoutCfg = {
        layout: ClChart.DEF_CHART.CHART_LAYOUT,
        config: ClChart.DEF_CHART.CHART_MDAY,
        rectMain: {
          left: 0,
          top: 0,
          width: mainCanvas.width,
          height: mainHeight
        }
      }
      Chart.createChart('user.mday.line', 'system.chart', mainLayoutCfg, function (result) {
        //  console.log(result)
      })
      const volumeLoyoutCfg = {
        layout: ClChart.DEF_CHART.CHART_LAYOUT,
        config: ClChart.DEF_CHART.CHART_MDAYVOL,
        rectMain: {
          left: 0,
          top: mainHeight,
          width: mainCanvas.width,
          height: mainCanvas.height - mainHeight
        }
      }
      Chart.createChart('user.mday.vol', 'system.chart', volumeLoyoutCfg, function (result) {
        //  console.log(result)
      })
    }    
    function paintDrawline() {
      const code = 'sh600600'

      let infoData
      Promise.all([
        sisClient.getData(code, 'info'),
        sisClient.getData(code, 'mday', { search:{ start:-1200,stop:-1 } }),
        sisClient.getData(code, 'now')
      ])
      .then(([infoData,  mdayData,  nowData]) => {
        Chart.clear()
        Chart.initData(20190419, ClChart.DEF_DATA.STOCK_TRADETIME)
        Chart.setData('INFO', ClChart.DEF_DATA.FIELD_INFO, infoData.value)
        Chart.setData('MDAY', ClChart.DEF_DATA.FIELD_TICK, mdayData.values)
        Chart.setData('NOW', ClChart.DEF_DATA.FIELD_NOW, nowData.value)
        
        Chart.bindData(Chart.getChart('user.mday.line'), 'MDAY')
        Chart.bindData(Chart.getChart('user.mday.vol'), 'MDAY')

        Chart.onPaint()

      })
    }
      
    window.onload = () => {
      initLayout()
      paintDrawline()
    }
  </script>
</body>
</html>